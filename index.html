<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapas Mentais - Direito</title>
    <!-- 1. Importando o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.1. Importando a fonte 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 2. Estilos CSS customizados e responsivos (Minimalista, Estrutura de Outline) -->
    <style>
        /* Fonte padrão e fundo suave */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; 
            background-color: #f7f9fb; /* Fundo muito leve */
        }

        /* Cores de Nível para Ícones e Borda (UX para hierarquia) */
        .depth-0 { --color-primary: #1d4ed8; } /* Azul Escuro (Raiz) */
        .depth-1 { --color-primary: #059669; } /* Verde (Grande Seção) */
        .depth-2 { --color-primary: #d97706; } /* Laranja (Sub-Seção) */
        .depth-3 { --color-primary: #4b5563; } /* Cinza (Detalhe/Folhas) */

        /* --- Estilos do Mapa Mental (Estrutura de Outline/Lista) --- */

        /* Contêiner principal da lista (Substitui map-item-card) */
        .map-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        /* Estilo de cada item (li) */
        .map-list-item {
            position: relative; /* Necessário para posicionar o marcador */
            cursor: pointer;
            padding: 0.75rem 0; 
            border-bottom: 1px solid #e5e7eb; /* Divisor sutil */
        }

        /* Linha de Hierarquia (Usando a borda da indentação) */
        .map-list .map-list {
            padding-left: 0.75rem; /* Indentação mobile (compacta) - Reduzido para 0.75rem */
            border-left: 3px solid #e5e7eb; /* AUMENTADO PARA 3PX */
        }

        /* --- Estilos do Marcador + / - (NOVO) --- */
        .map-list-item.collapsible {
            padding-left: 0.75rem; /* Para itens que podem ser expandidos, ajeitamos o espaço - Reduzido para 0.75rem */
        }
        /* Item não colapsável (folha) */
        .map-list-item:not(.collapsible) {
            padding-left: 0.75rem; /* Reduzido para 0.75rem */
        }

        .map-list-item.collapsible::before {
            content: '+'; /* Conteúdo inicial */
            position: absolute;
            left: -0.3rem; /* Posição ajustada para ser mais compacta - Reduzido para -0.3rem */
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 14px;
            font-size: 14px; /* Fonte menor para compactação */
            font-weight: 700;
            color: var(--color-primary);
            background-color: #f7f9fb; /* Cor de fundo para cobrir a linha */
            border: 2px solid var(--color-primary); /* Borda com cor do nível */
            border-radius: 4px;
            transition: content 0.4s ease;
        }

        .map-list-item.collapsible.open::before {
            content: '–'; /* Muda para - quando aberto */
        }

        /* Ajuste de posição para UL's internos (mobile) */
        @media (max-width: 767px) {
            .map-list .map-list .map-list-item.collapsible::before {
                left: calc(-0.75rem - 0.3rem); /* Indentação de 0.75rem + 0.3rem do marcador */
            }
        }
        
        /* Estilo do Título/Header */
        .item-header {
            display: flex;
            align-items: center; 
            transition: background-color 0.15s ease;
            padding: 0.5rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 0.25rem;
        }
        
        /* Hover e Ícone */
        .item-header:hover {
            background-color: #eff6ff; /* Cor muito leve no hover */
        }

        /* Estilos dos Conteúdos Colapsáveis (ul dentro de li) */
        .collapsible-content {
            display: grid;
            grid-template-rows: 0fr; /* Fechado */
            transition: grid-template-rows 0.4s ease-in-out;
            margin-top: 0;
        }

        .collapsible-content.open {
            grid-template-rows: 1fr; /* Abre */
        }

        .collapsible-inner {
            overflow: hidden; /* Oculta o conteúdo no estado fechado */
        }

        /* Classes de texto por nível (Mobile-First) */
        .title-text {
            flex-grow: 1;
        }
        
        .depth-0 .title-text { font-size: 1.15rem; font-weight: 700; color: #1f2937; } /* Raiz - Menor */
        .depth-1 .title-text { font-size: 1rem; font-weight: 600; color: #059669; } /* Verde - Menor */
        .depth-2 .title-text { font-size: 0.95rem; font-weight: 500; color: #d97706; } /* Laranja - Menor */
        .depth-3 .title-text { font-size: 0.85rem; font-weight: 400; color: #4b5563; } /* Cinza - Menor */


        @media (min-width: 768px) {
            /* Otimizações para Desktop (Volta ao espaçamento maior) */
             .depth-0 .title-text { font-size: 1.75rem; } 
             .depth-1 .title-text { font-size: 1.25rem; }
             
             .map-list .map-list {
                padding-left: 1.5rem; /* Indentação Reduzida para 1.5rem */
            }
             .map-list-item.collapsible {
                padding-left: 1.5rem; /* Reduzido para 1.5rem */
            }
            .map-list-item:not(.collapsible) {
                padding-left: 1.5rem; /* Reduzido para 1.5rem */
            }
             .map-list .map-list .map-list-item.collapsible::before {
                left: calc(-1.5rem - 0.75rem); /* Ajuste de posição para desktop (18px marcador) */
            }
             .map-list-item.collapsible::before {
                width: 18px;
                height: 18px;
                line-height: 16px;
                font-size: 16px;
                left: -0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Barra Superior (Header) -->
    <header class="bg-white text-gray-800 shadow-lg sticky top-0 left-0 right-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Lado Esquerdo: Hamburger e Logo -->
                <div class="items-center flex">
                    <!-- Botão Hamburger -->
                    <button id="hamburger-btn" class="p-2 rounded-md text-gray-500 hover:text-indigo-600 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 focus:text-indigo-600">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <!-- Logo -->
                    <div class="ml-4 text-xl font-bold text-indigo-700">
                        DireitoMap
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Menu Lateral (Sidebar) -->
    <aside id="sidebar" class="bg-white w-72 h-full fixed top-0 left-0 z-40 shadow-xl transform -translate-x-full pt-16">
        <nav id="sidebar-content" class="py-4 px-2 overflow-y-auto h-full"></nav>
    </aside>

    <!-- Overlay (fundo escuro quando o menu está aberto) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" aria-hidden="true"></div>

    <!-- Área de Conteúdo Principal -->
    <main id="content-area" class="pt-12 pb-12 max-w-4xl mx-auto px-4">
        <div class="bg-white p-8 rounded-xl shadow-md text-center border border-gray-200">
            <h2 class="text-2xl font-semibold text-indigo-700">Bem-vindo(a) ao seu Mapa Mental de Direito!</h2>
            <p class="mt-4 text-gray-600">Selecione uma disciplina e um tema no menu lateral para começar a estudar de forma interativa.</p>
        </div>
    </main>

    <!-- 4. O Código JavaScript com Lógica de Renderização e IA -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            // 1. Seleciona os elementos principais da UI
            const sidebar = document.getElementById('sidebar');
            const sidebarContent = document.getElementById('sidebar-content');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const overlay = document.getElementById('overlay');
            const contentArea = document.getElementById('content-area');

            // Variável para armazenar o prompt customizado
            let currentPromptTemplate = ''; 

            // 2. Função para abrir/fechar o menu lateral
            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }
            
            // --- FUNÇÃO PARA MANIPULAR O ACORDEÃO (CLIQUE) ---
            function toggleAccordion(event) {
                const item = event.target.closest('.map-list-item');
                if (!item) return;

                const childrenContainer = item.querySelector('.collapsible-content');
                if (!childrenContainer) return;

                const parentList = item.parentElement; // O <ul> pai
                const isCurrentlyOpen = childrenContainer.classList.contains('open');
                
                // Lógica de fechamento de irmãos (siblings) - NOVO: Garante o foco
                if (!isCurrentlyOpen) {
                    Array.from(parentList.children).forEach(sibling => {
                        // Verifica se o irmão é colapsável e não é o item clicado
                        if (sibling !== item && sibling.classList.contains('collapsible')) {
                            const siblingChildren = sibling.querySelector('.collapsible-content');
                            if (siblingChildren && siblingChildren.classList.contains('open')) {
                                // Fecha o irmão
                                siblingChildren.classList.remove('open');
                                sibling.classList.remove('open');
                            }
                        }
                    });
                }


                // Lógica para abrir/fechar o item clicado
                if (isCurrentlyOpen) {
                    // Fechar o item clicado
                    childrenContainer.classList.remove('open');
                    item.classList.remove('open');
                } else {
                    // Abrir o item clicado (após fechar os irmãos)
                    childrenContainer.classList.add('open');
                    item.classList.add('open');
                }
                
                event.stopPropagation();
            }


            // 3. Função para construir o menu lateral dinamicamente
            async function buildSidebarMenu() {
                let menuHtml = '';

                try {
                    const response = await fetch(`data/index_menu.json?v=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar o menu: ${response.statusText}`);
                    }
                    const menuData = await response.json();

                    menuData.forEach(disciplina => {
                        menuHtml += `<details class="group px-2 py-1" open>`;
                        menuHtml += `
                            <summary class="flex justify-between items-center p-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors focus:outline-none">
                                <span class="font-bold text-lg text-indigo-800">${disciplina.disciplina}</span>
                                <svg class="w-5 h-5 transform group-open:rotate-90 transition-transform text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </summary>
                        `;

                        menuHtml += `<ul class="pl-2 mt-1 space-y-1">`;
                        disciplina.temas.forEach(tema => {
                            menuHtml += `
                                <li>
                                    <a href="#" 
                                       class="block p-2 rounded-lg text-gray-700 hover:bg-indigo-100 hover:text-indigo-800 transition-colors"
                                       data-path="${tema.path}"
                                       data-disciplina="${disciplina.disciplina}">
                                        ${tema.nome}
                                    </a>
                                </li>
                            `;
                        });
                        menuHtml += `</ul></details>`;
                    });

                    sidebarContent.innerHTML = menuHtml;

                } catch (error) {
                    console.error("Erro ao construir o menu:", error);
                    sidebarContent.innerHTML = `<p class="p-4 text-red-500">Erro: Não foi possível carregar o menu. Verifique o arquivo 'data/index_menu.json'.</p>`;
                }
            }


            // 4. Função para carregar um mapa mental na tela
            async function loadMindMap(path, disciplina) {
                try {
                    contentArea.innerHTML = ''; // Limpa antes de carregar

                    const response = await fetch(`${path}?v=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error(`Status: ${response.status}`);
                    }
                    const mapData = await response.json();

                    // Armazena o template de prompt personalizado (ou usa um padrão)
                    currentPromptTemplate = mapData.iaPromptTemplate || 
                        "explique como um professor de direito explicaria para seus alunos de modo didático, explicativo e fundamentado sobre o tema: [TOPIC][CONTEXT]";


                    // 4.1. Título do Mapa
                    const title = document.createElement('h1');
                    title.className = "text-3xl md:text-4xl font-bold text-indigo-700 mb-6 mt-4 text-center";
                    title.textContent = mapData.titulo;
                    contentArea.appendChild(title);

                    // 4.2. Contêiner Principal
                    const mapContainer = document.createElement('div');
                    mapContainer.className = "map-list-container p-4 md:p-8 bg-white rounded-xl shadow-md";
                    
                    // 4.3. Cria o nó raiz (Depth 0)
                    const rootList = document.createElement('ul');
                    rootList.className = 'map-list';

                    const rootNode = createMapNode(mapData.topicoRaiz, [disciplina], 0);
                    rootList.appendChild(rootNode);

                    mapContainer.appendChild(rootList);
                    contentArea.appendChild(mapContainer);

                    // NOVO: Desloca a página para o topo do conteúdo do mapa
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                } catch (error) {
                    console.error(`Erro ao carregar o mapa de '${path}':`, error);
                    contentArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-8">
                                                <strong class="font-bold">Erro de Carregamento:</strong>
                                                <span class="block sm:inline">Não foi possível carregar o mapa mental. Verifique a URL do arquivo (${path}) e sua sintaxe JSON.</span>
                                            </div>`;
                }
            }

            // 5. Função Recursiva para criar os nós do mapa (Estrutura de Lista)
            function createMapNode(nodeData, pathArray, depth) {
                // O nó é um elemento <li>
                const item = document.createElement('li');
                item.className = 'map-list-item';
                
                // Define a classe de cor com base na profundidade
                const colorClass = `depth-${Math.min(depth, 3)}`;

                // Verifica se tem filhos
                const hasChildren = nodeData.filhos && nodeData.filhos.length > 0;
                
                // Adiciona classe de controle para o CSS
                if (hasChildren) {
                    item.classList.add('collapsible');
                }
                
                // --- 5.1. Header do Tópico (Contém Título e Botões) ---
                const header = document.createElement('div');
                header.className = `item-header ${colorClass}`;
                
                
                // Se tiver filhos, adiciona o evento de clique ao header
                if (hasChildren) {
                    header.addEventListener('click', toggleAccordion);
                    // Adiciona o estilo de hover customizado baseado na cor primária
                    header.onmouseover = function() {
                        const rootStyle = getComputedStyle(document.documentElement);
                        const primaryColor = rootStyle.getPropertyValue(`--color-primary`);
                        header.style.backgroundColor = primaryColor + '05'; // Adiciona 5% de opacidade
                    };
                    header.onmouseout = function() {
                         header.style.backgroundColor = 'transparent';
                    };
                }


                // Título do Tópico
                const titleText = document.createElement('span');
                // Alinha o texto do item à esquerda, sem a borda colorida aqui. A borda é feita pelo pseudo-elemento.
                titleText.className = `title-text flex-grow`; 
                titleText.textContent = nodeData.nome;
                header.appendChild(titleText);


                // Mini Botão de IA (Sempre presente)
                const button = document.createElement('button');
                button.className = 'explain-btn ml-3 flex-shrink-0 p-1 rounded-full hover:bg-indigo-100 transition-colors focus:outline-none';
                button.dataset.topic = nodeData.nome;
                button.dataset.path = JSON.stringify(pathArray);
                button.setAttribute('aria-label', `Explicar tópico ${nodeData.nome}`);
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block text-[color:var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                header.appendChild(button);
                item.appendChild(header);

                // --- 5.2. Contêiner dos Filhos (Acordeão) ---
                if (hasChildren) {
                    const childrenContainer = document.createElement('div');
                    // Começa FECHADO
                    childrenContainer.className = 'collapsible-content'; 
                    
                    const innerWrapper = document.createElement('div');
                    innerWrapper.className = 'collapsible-inner';
                    
                    // Cria os filhos (recursão)
                    const childrenList = document.createElement('ul');
                    childrenList.className = 'map-list space-y-1';

                    const newPathArray = [...pathArray, nodeData.nome];
                    nodeData.filhos.forEach(filhoNode => {
                        const filhoElement = createMapNode(filhoNode, newPathArray, depth + 1);
                        childrenList.appendChild(filhoElement);
                    });

                    innerWrapper.appendChild(childrenList);
                    childrenContainer.appendChild(innerWrapper);
                    item.appendChild(childrenContainer);
                }

                return item; // Retorna o item completo
            }


            // --- 6. Configuração dos Eventos ---

            // Evento para abrir/fechar o menu
            hamburgerBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            // Evento para cliques DENTRO do menu lateral (carregar mapas)
            sidebarContent.addEventListener('click', (event) => {
                const link = event.target.closest('a[data-path]');
                
                if (link) {
                    event.preventDefault();
                    const path = link.dataset.path;
                    const disciplina = link.dataset.disciplina; 
                    loadMindMap(path, disciplina); 
                    
                    // Fecha o menu em todas as telas
                    toggleSidebar();
                }
            });

            // Evento para cliques DENTRO da área de conteúdo (botões de explicação)
            contentArea.addEventListener('click', (event) => {
                const button = event.target.closest('.explain-btn');
                if (!button) {
                    return;
                }

                const topic = button.dataset.topic;
                if (!topic) {
                    return;
                }

                // 1. Monta o novo prompt com o caminho (CONTEXT)
                const pathString = button.dataset.path;
                const pathArray = pathString ? JSON.parse(pathString) : [];
                const context = pathArray.length > 0 ? ` (${pathArray.join(', ')})` : '';
                
                // 2. Aplica os placeholders no template
                let finalQuery = currentPromptTemplate
                    .replace(/\[TOPIC\]/g, topic)
                    .replace(/\[CONTEXT\]/g, context);

                const encodedQuery = encodeURIComponent(finalQuery);
                
                // 3. Abre a nova URL
                const googleUrl = `https://www.google.com/search?udm=50&q=${encodedQuery}`;
                
                window.open(googleUrl, '_blank');
            });


            // --- 7. Inicialização ---
            await buildSidebarMenu(); 
        });
    </script>

</body>
</html>
