<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapas Mentais - Direito</title>
    <!-- 1. Importando o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1.1 Importando a fonte 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 2. Estilos CSS customizados (Apenas o essencial) -->
    <style>
        /* Fonte padrão */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Previne scroll horizontal */
            background-color: #f9fafb; /* bg-gray-50 */
        }

        /* --- Estilos do Layout (Sidebar/Header) --- */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        #overlay {
            transition: opacity 0.3s ease-in-out;
        }

        /* --- Estilos do Mapa Retrátil (Acordeão) --- */
        
        /* Ícone da seta (chevron) que gira */
        .chevron-icon {
            transition: transform 0.3s ease;
            flex-shrink: 0; 
        }
        .chevron-icon.open {
            transform: rotate(90deg);
        }

        /* O contêiner dos "filhos" que anima */
        .node-children-container {
            max-height: 0;
            overflow: hidden;
            /* Transição para a animação suave de expansão */
            transition: max-height 0.4s ease-in-out, padding-top 0.4s ease-in-out;
        }

        /* Estado "aberto" do contêiner */
        .node-children-container.open {
            max-height: 5000px; /* Valor alto para garantir que o conteúdo caiba */
            padding-top: 8px; /* Adiciona um espaço quando está aberto */
        }

        /* Efeito de hover no header do card quando ele é clicável */
        .node-header.clickable:hover {
            background-color: #f9fafb; /* Cor suave de hover */
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- 3. Estrutura HTML do Aplicativo -->

    <!-- Barra Superior (Header) -->
    <header class="bg-white text-gray-800 shadow-sm fixed top-0 left-0 right-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Lado Esquerdo: Hamburger e Logo -->
                <div class="flex items-center">
                    <!-- Botão Hamburger -->
                    <button id="hamburger-btn" class="p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 focus:text-gray-900">
                        <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <!-- Logo -->
                    <div class="ml-4 text-xl font-bold text-indigo-600">
                        DireitoMap
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Menu Lateral (Sidebar) -->
    <aside id="sidebar" class="bg-white w-72 h-full fixed top-0 left-0 z-40 shadow-xl transform -translate-x-full pt-16">
        <!-- O conteúdo do menu será gerado pelo JS aqui -->
        <nav id="sidebar-content" class="py-4 px-2 overflow-y-auto h-full"></nav>
    </aside>

    <!-- Overlay (fundo escuro quando o menu está aberto) -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Área de Conteúdo Principal -->
    <main id="content-area" class="pt-24 pb-12 max-w-4xl mx-auto px-4">
        <!-- O mapa mental ou a msg de bem-vindo serão carregados aqui -->
    </main>

    <!-- 4. O Código JavaScript -->
    <script>
        
        // Variável para armazenar o template de prompt do arquivo JSON carregado
        let currentIaPromptTemplate = "explique como um professor de direito explicaria para seus alunos de modo didático, explicativo e fundamentado sobre o tema: [TOPIC][CONTEXT]";


        // Espera a página carregar para executar o script
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 1. Seleciona os elementos principais da UI
            const sidebar = document.getElementById('sidebar');
            const sidebarContent = document.getElementById('sidebar-content');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const overlay = document.getElementById('overlay');
            const contentArea = document.getElementById('content-area');

            // 2. Função para abrir/fechar o menu lateral
            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('translate-x-0');
                overlay.classList.toggle('hidden');
            }

            // Função para mostrar a mensagem de boas-vindas
            function showWelcomeMessage() {
                contentArea.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                        <h2 class="text-2xl font-semibold text-gray-700">Bem-vindo(a) ao DireitoMap!</h2>
                        <p class="mt-4 text-gray-500">Selecione uma disciplina e um tema no menu lateral para começar a estudar.</p>
                    </div>
                `;
            }

            // 3. Função para construir o menu lateral dinamicamente
            async function buildSidebarMenu() {
                let menuHtml = '';
                try {
                    // Busca o arquivo de menu (com cache buster para garantir a atualização)
                    const response = await fetch(`data/index_menu.json?v=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar o menu: ${response.statusText}`);
                    }
                    const menuData = await response.json();

                    // Itera sobre as disciplinas e temas
                    menuData.forEach(disciplina => {
                        menuHtml += `<details class="group px-2 py-1" open>`; 
                        menuHtml += `
                            <summary class="flex justify-between items-center p-2 rounded-md cursor-pointer hover:bg-gray-100">
                                <span class="font-semibold text-gray-700">${disciplina.disciplina}</span>
                                <svg class="w-4 h-4 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </summary>
                        `;
                        
                        menuHtml += `<ul class="pl-4 mt-1">`;
                        disciplina.temas.forEach(tema => {
                            menuHtml += `
                                <li>
                                    <a href="#" 
                                       class="block p-2 rounded-md text-gray-600 hover:bg-indigo-50 hover:text-indigo-700"
                                       data-path="${tema.path}"
                                       data-disciplina="${disciplina.disciplina}">
                                        ${tema.nome}
                                    </a>
                                </li>
                            `;
                        });
                        menuHtml += `</ul></details>`;
                    });
                    
                    sidebarContent.innerHTML = menuHtml;

                } catch (error) {
                    console.error("Erro ao construir o menu:", error);
                    sidebarContent.innerHTML = `<p class="p-4 text-red-500">Não foi possível carregar o menu. Verifique se o arquivo 'data/index_menu.json' existe.</p>`;
                }
            }

            // 4. Função para carregar um mapa mental na tela
            async function loadMindMap(path, disciplina) {
                try {
                    // Busca o arquivo JSON do mapa mental
                    const response = await fetch(`${path}?v=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar o mapa: ${response.statusText}`);
                    }
                    const mapData = await response.json();

                    // Armazena o template de prompt se existir no JSON, senão usa o padrão.
                    if (mapData.iaPromptTemplate) {
                        currentIaPromptTemplate = mapData.iaPromptTemplate;
                    } else {
                        // Reseta para o padrão se o novo JSON não tiver template
                        currentIaPromptTemplate = "explique como um professor de direito explicaria para seus alunos de modo didático, explicativo e fundamentado sobre o tema: [TOPIC][CONTEXT]";
                    }


                    contentArea.innerHTML = ''; // Limpa a área

                    // Adiciona o título principal
                    const title = document.createElement('h1');
                    title.className = "text-3xl md:text-4xl font-bold text-indigo-600 mb-8 text-center";
                    title.textContent = mapData.titulo;
                    contentArea.appendChild(title);
                    
                    // Chama a função recursiva para construir o mapa
                    const rootNode = createMapNode(mapData.topicoRaiz, [disciplina], 0); 
                    contentArea.appendChild(rootNode); // Adiciona o card raiz direto na área de conteúdo

                } catch (error) {
                    console.error(`Erro ao carregar o mapa de '${path}':`, error);
                    contentArea.innerHTML = `<p class="p-4 text-center text-red-500">Não foi possível carregar o mapa mental. Verifique se o arquivo '${path}' existe e está formatado corretamente.</p>`;
                    setTimeout(showWelcomeMessage, 3000); 
                }
            }

            /**
             * 5. Função Recursiva para criar os nós do mapa (Cards Retráteis)
             */
            function createMapNode(nodeData, pathArray, depth) {
                const item = document.createElement('div');
                
                // --- 1. Define Cores por Nível ---
                const borderColors = [
                    'border-indigo-500', // Nível 0 (Raiz)
                    'border-blue-500',   // Nível 1
                    'border-cyan-500',   // Nível 2
                    'border-teal-500',   // Nível 3
                    'border-gray-400'    // Nível 4+
                ];
                const borderColor = borderColors[depth] || borderColors[borderColors.length - 1];

                const textColors = [
                    'text-indigo-700 font-semibold text-lg', // Nível 0 (Raiz)
                    'text-blue-700 font-semibold',       // Nível 1
                    'text-cyan-700 font-medium',         // Nível 2
                    'text-teal-700 font-medium',         // Nível 3
                    'text-gray-700 font-medium'          // Nível 4+
                ];
                const baseTextColor = textColors[depth] ? textColors[depth].split(' ')[0] : 'text-gray-700'; 
                const textColor = textColors[depth] || textColors[textColors.length - 1];

                // --- 2. Cria o Card (o item) ---
                const marginClass = depth > 0 ? 'mt-4' : ''; 
                item.className = `map-node-card bg-white rounded-lg shadow-lg ${marginClass} border-l-4 ${borderColor}`;
                
                const hasChildren = nodeData.filhos && nodeData.filhos.length > 0;
                
                // --- 3. Cria o Header (Texto + Botões) ---
                const header = document.createElement('div');
                header.className = `node-header flex justify-between items-center w-full p-4`;
                
                // Wrapper para o conteúdo da esquerda (Ícone + Texto)
                const textWrapper = document.createElement('div');
                textWrapper.className = 'flex-1 flex items-center min-w-0'; 

                // Adiciona o Ícone Chevron (seta) se tiver filhos
                if (hasChildren) {
                    header.classList.add('clickable'); 
                    const chevron = document.createElement('div');
                    chevron.className = `chevron-icon w-5 h-5 mr-3 ${baseTextColor}`;
                    chevron.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                    textWrapper.appendChild(chevron);
                } else {
                    // Se não tem filhos, adiciona um espaço vazio para manter o alinhamento
                    textWrapper.className = 'flex-1 flex items-center min-w-0 pl-8'; 
                }

                // Texto do Tópico
                const text = document.createElement('span');
                text.className = `flex-1 text-base ${textColor} truncate`; 
                text.textContent = nodeData.nome;
                text.dataset.topic = nodeData.nome;
                textWrapper.appendChild(text);
                
                header.appendChild(textWrapper);

                // Botão de Explicação (Sempre aparece)
                const button = document.createElement('button');
                button.className = 'explain-btn ml-3 text-gray-400 hover:text-indigo-600 flex-shrink-0 z-10'; 
                button.dataset.topic = nodeData.nome;
                button.setAttribute('aria-label', `Explicar tópico ${nodeData.nome}`);
                button.dataset.path = JSON.stringify(pathArray);
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                header.appendChild(button);
                
                item.appendChild(header); // Adiciona o header ao card

                // --- 4. Cria o Contêiner dos Filhos (se houver) ---
                if (hasChildren) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = `node-children-container px-4 pb-2 pl-12`; 
                    
                    // O Tópico Raiz (depth 0) começa aberto
                    if (depth === 0) {
                        childrenContainer.classList.add('open');
                        header.querySelector('.chevron-icon').classList.add('open');
                    }

                    const newPathArray = [...pathArray, nodeData.nome];
                    const newDepth = depth + 1;
                    nodeData.filhos.forEach(filhoNode => {
                        const filhoElement = createMapNode(filhoNode, newPathArray, newDepth);
                        childrenContainer.appendChild(filhoElement);
                    });
                    
                    item.appendChild(childrenContainer); // Adiciona o contêiner de filhos ao card
                }

                return item; 
            }


            // --- 6. Configuração dos Eventos ---

            hamburgerBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            sidebarContent.addEventListener('click', (event) => {
                const link = event.target.closest('a[data-path]');
                
                if (link) {
                    event.preventDefault();
                    const path = link.dataset.path;
                    const disciplina = link.dataset.disciplina; 
                    loadMindMap(path, disciplina); 
                    
                    if (window.innerWidth < 768) {
                        toggleSidebar();
                    }
                }
            });

            // Event listener unificado para a área de conteúdo
            contentArea.addEventListener('click', (event) => {
                const explainButton = event.target.closest('.explain-btn');
                
                // --- 1. Clique no Botão de Explicação ---
                if (explainButton) {
                    event.stopPropagation(); 
                    
                    const topic = explainButton.dataset.topic;
                    if (!topic) return;

                    const pathString = explainButton.dataset.path;
                    const pathArray = pathString ? JSON.parse(pathString) : [];
                    // Contexto formatado: (Disciplina, Tópico Pai, Subtópico...)
                    const context = pathArray.length > 0 ? ` (${pathArray.join(', ')})` : '';
                    
                    // --- MONTAGEM DO PROMPT PERSONALIZADO ---
                    let queryText = currentIaPromptTemplate.replace('[TOPIC]', topic);

                    // 2. Garante que o contexto é sempre incluído
                    if (queryText.includes('[CONTEXT]')) {
                        queryText = queryText.replace('[CONTEXT]', context);
                    } else {
                        // Se não houver placeholder [CONTEXT], anexa-o ao final
                        queryText = queryText + context;
                    }

                    const encodedQuery = encodeURIComponent(queryText);
                    const googleUrl = `https://www.google.com/search?udm=50&q=${encodedQuery}`;
                    
                    window.open(googleUrl, '_blank');
                    return; 
                }

                // --- 2. Clique no Header para Expandir/Colapsar ---
                const header = event.target.closest('.node-header.clickable');
                if (header) {
                    const chevron = header.querySelector('.chevron-icon');
                    if (chevron) {
                        chevron.classList.toggle('open');
                    }
                    
                    const childrenContainer = header.nextElementSibling;
                    if (childrenContainer && childrenContainer.classList.contains('node-children-container')) {
                        childrenContainer.classList.toggle('open');
                    }
                }
            });


            // --- 7. Inicialização ---
            await buildSidebarMenu(); 
            showWelcomeMessage(); 

        });
    </script>

</body>
</html>
